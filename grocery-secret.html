<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Encrypted Page</title>
  <style>
    body {
	  font-family: sans-serif;
      background: #ddd;
      text-align: center;
      padding-top: 3em;
    }
    #gate {
      max-width: 20em;
      margin: auto;
    }
    #gate h1 {
      font-size: 1.2em;
      font-weight: normal;
    }
    #pw {
      width: 100%;
      max-width: 100%;
      background: white;
      padding: 0.8em;
      font-size: 1em;
      border: 1px solid #aaa;
      border-radius: 0.3em;
      box-sizing: border-box;
      margin: 0.5em 0;
    }
    #go {
      padding: 0.8em;
      font-size: 1em;
      border: 1px solid #666;
      background: #f8f8f8;
      border-radius: 0.3em;
      margin-top: 0.5em;
      cursor: pointer;
    }
    #go:hover {
      background: #eee;
    }
    #go:active {
      background: #ddd;
    }
    #msg {
      color: red;
      margin-top: 0.5em;
    }
   </style>
</head>
<body>
  <div id="gate">
    <h1>Enter password</h1>
    <input id="pw" type="password">
    <button id="go">Decrypt</button>
    <div id="msg">password is 'pickles'</div>
  </div>
<script>
// decrypt.js
// This function only:
// Copyright 2025 Joseph Kroesche
// Subject to MIT license: https://choosealicense.com/licenses/mit/
//
async function decryptHtml(password, ciphertextB64, tagB64, ivB64, saltB64, iterations) {
  const enc = new TextEncoder();
  const dec = new TextDecoder();

  function b64ToBytes(b64) {
    const bin = atob(b64);
    const out = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
    return out;
  }

  function concatBytes(a, b) {
    const out = new Uint8Array(a.length + b.length);
    out.set(a, 0);
    out.set(b, a.length);
    return out;
  }

  async function deriveAesGcmKey(passwordBytes, saltBytes, iterations) {
    const baseKey = await crypto.subtle.importKey(
      "raw",
      passwordBytes,
      "PBKDF2",
      false,
      ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: saltBytes,
        iterations: iterations,
        hash: "SHA-256"
      },
      baseKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["decrypt"]
    );
  }

  const salt = b64ToBytes(saltB64);
  const iv = b64ToBytes(ivB64);
  const ct = b64ToBytes(ciphertextB64);
  const tag = b64ToBytes(tagB64);
  const ctPlusTag = concatBytes(ct, tag);

  const key = await deriveAesGcmKey(enc.encode(password), salt, iterations);

  const plainBuf = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: iv, tagLength: 128 },
    key,
    ctPlusTag.buffer
  );

  return dec.decode(new Uint8Array(plainBuf));
}


(async () => {
  const params = {
    iterations: 200000,
    salt_b64: "7iq4TPNn3epzpBoz73/ssQ==",
    iv_b64: "HSYh8JGvgZ2kxDYT",
    ciphertext_b64: "/66AagpGeXZkAGdBnVfjdtyqZETN4A14ZPdJuiBRJR/+VpsmUm0+k83j0TGnh/B0FE2PxoOLXHor26Qm/NcUpayhw0ynWmUO48wZCBWhccGvfGh3h08NFPFV8yBayA+Iwqx6GVYzb+Ev4EYrbOeUxSwf0gYdjwTyGsANYkk9JB53t8WnjWh0ut1hx6YqDjQwlQeY2eg2YiS89XJyNMv69KUctES0pygGG9HZeTzICoQRacAR77++xhMhymothstLOXazBSdFScNDfu1kdgssUNK3bXmMvqIu5PLF1eIbWLSOHf3wHw9IjJAbfIEfwSde1P8a7s9UtV8X7cxS2xwdxbAG3dY0ttNOa/cSyJWMlhyCQ5BCAlqhbOIJ8eBTblMszdjkd126rHqjUUbSs1vXYdxVgANjo5CghyuXzndQkGTPsZYEogqTNxiOrL7MMH1tAHBJKhB88n7WVW1Bj1e+D5PGthWFr4tuPatisPvdVPDzv+aXOJiYLbAsDGY8kEwxkSbBpfwvBsz7aR0w1Iw3uqvKAxVseipMFa+7s6tklQLtVHoLhYJPcN0r2frV4kGAN5UZ+Qag+prRU8UqD6VFaPvnH8Ct3Y3gsMsjZB/fK3OMsjEz0ptgkZX5IeUQAIBREptg/HUTstqMR2Xynyh1FHAqMsCYjLiIjH8REHokCEE2DdTTobEYc9Y9ZcCJDsSPnQQmBFLBLbHf71MbPVzg0GcWtBmR3hquzgcnNAMQNlSftiwlnhkapH6pzGM29Wq89gRh/V97524LaMTnqOEalVHPQarFALh7TCxUtm/bC+zQAtetufLs5wp3Wx/P43gAwwLhlglkNL9RB8q58TlsO/ztBjeU8FmZd944Q2RF1eKjxMYXTipmk6zFxCcOXyXEenUCl76mXM6wqAYnWlT4YRX4lO2q8iUboQLnJBHFFQC8mizcblGvO9a1kauNG45mqS9/d5cktgIPsq2nu0+iL2yIqOabFBvleAaoA8EYABRYp6DpuQUZRPibupcSDYccxajvNwnaW7BFqVvoTRDsAsaklrAWW//Ukd3kNUKVM1jJiYaaHnC2O3KUEfhHn3hgYP5JscasUGcXUax0KY0Tb8Y1TxnpgwYvFmZ4573c6K0vM92VSiZrtVcHCpOYAgCtrx1rFCh86fGl/u+MvMISySx40I3sXNtYdJN2/+oLGEa1S8mIBYsCZW25qnVE0L8mZpfjYJ5L/3T9z1bsmRnpgg44nye7mP5dKskF23IpQZWEFAi9LEOom9kPVppKLcagbwCI0oby41OfKJ0DRETs8Z8KoVJJU1xELQeRJcGRaX5PndmYeFme/Ewl76GgvuiTH4E4wPFohu0nLTTTFVQm4ER19nYs0Pdw3k80SmWqBSO0n40yzqEN7rfHdTUeAOf43JZhGcbj/3ewcSqGafpvuugTiMpTT0cw1hV72mPV1RvBam5Ys5A5zyMTJusmUxJJsUNW9rL6gO5UWr8YLe0QctzDUT3/FQL3X2i0YeGv3RpNlKxEdkZiqeHp9mKf2ujbO2FKk7OjNqYqqiqDZjt9r/kOyBCBX8tIIHcRI64JWGILSgM1wIBxs1VBDe6aLzBYgswW8gL+X9F3yhOg46GLVqFSjVFW3nVxGmgO9tZDWRP9xerxdISC0AWA8gmjkTUcKNE74srXkW8=",
    tag_b64: "C4ILBaf+A7sPUtBGh6MmPQ=="
  };

  async function onGo() {
    const pw = document.getElementById("pw").value;
    try {
      const html = await decryptHtml(
        pw,
        params.ciphertext_b64,
        params.tag_b64,
        params.iv_b64,
        params.salt_b64,
        params.iterations
      );
      document.documentElement.innerHTML = html;
    } catch (e) {
      document.getElementById("msg").textContent = "Decryption failed.";
    }
  }

  const pwBox = document.getElementById("pw");
  const goBtn = document.getElementById("go");

  goBtn.addEventListener("click", onGo);
  pwBox.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      onGo();
    }
  });
})();
</script>
</body>
</html>
